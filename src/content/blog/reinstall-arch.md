+++
title = "Arch Linux再インストールで発見したこと"
date = 2021-03-21
math = false
[taxonomies]
categories = ["code"]
tags = ["Linux", "Arch Linux", "systemd"]
+++
先日自分のミスでパーティションをブレイクしてしまい、Arch Linuxが起動不可の状態に。インストールメディアを準備して`arch-chroot`すればもしかしたら救出できたのかもしれなかったが、少し時間があったのでこの際、とクリーンインストールをした（ちょうどKDE neonを入れたサブ機を用意したてだったのが本当にラッキーだった）。前回インストールをしたのは１年前だったと思うが、少し様子が変わっていたのでメモ。

#### ログをとれるようになっていた
もしかするとこれは前からだったかもしれないが、インストール作業のログをとれるようになっている。また、ArchWikiへの誘導も冒頭にあって、ちょっぴり親切な雰囲気が醸し出されていた。

#### wifi-menuが使えない
最新のisoでは`wifi-menu`が含まれていないのか、開幕`wifi-menu`でとりあえずネットワーク接続を確保するということができない。  
ArchWikiでは`iwctl`による接続を推奨している。

~~~
iwctl
device list # デバイス名の確認
station <デバイス名> connect <アクセスポイント名>
~~~

これでOK。接続したら`ctrl+C`で抜けることを忘れずに。


#### systemd-bootの設定をミスしても泣かない
ここで何回かミスってしまったのだが、最初からやり直す必要はない。インストールメディアを挿したまま再起動し、ネットワーク接続を確保した後、マウント。

~~~
mount /dev/device2 /mnt
mount /dev/device1 /mnt/boot
~~~

その後、

~~~
arch-chroot /mnt
~~~

これで`/boot`以下の設定ファイルもいじれるようになる。

個人的にミスしやすいポイントとしては、`/boot/loader/entries/arch.conf`内のoptions行。  
`blkid`で調べたPARTUUIDを入れるのだが、間違えてUUIDを入れるとか、違うパーティションのPARTUUIDを入れてしまうといったミスが起こりやすい。ここは落ち着いて写真を撮って進行しましょう。

#### systemdでやりくりするように組む
以前は[この記事](@/post/archinstall.md)にあるようにブートローダーとしてgrubを選択していたのだけど、このコマンドを正確に打つのめっちゃ大変ですよね。systemd-bootに切り替えたほうがインストールは楽になるはず。  
ネットワーク接続についても、複数のパッケージで組もうとするとその分再インストールの手間が増え、手順も複雑になって後々わけがわからなくなるので、極力systemd内で生きていくように選択していったほうがよいように思う。  
ネットワーク接続は僕の場合、`iwd`を入れて`iwctl`で接続したのち、systemd-networkdとsystemd-resolvedを`enable`し、`dhcpcd`も入れてnetworkdの各種設定ファイルを作成、で再起動後も自動接続できた（こう書くとかなり面倒くさそうだが、意外とそうでもない）。
